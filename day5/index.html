<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Day 5 :二次元反応拡散方程式</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>

<style>
  .markdown-body {
    box-sizing: border-box;
    min-width: 200px;
    max-width: 980px;
    margin: 0 auto;
    padding: 45px;
  }
  p.caption{
    display:none;
  }
  img {width: 100%}

  @media (max-width: 767px) {
    .markdown-body {
      padding: 15px;
    }
  }
</style>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://kaityo256.github.io/sevendayshpc/github-markdown.css" type="text/css" />
  <script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
  type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<article class="markdown-body">
<header>
<h1 class="title">Day 5 :二次元反応拡散方程式</h1>
</header>
<!--- abstract --->
<p>Day
4では一次元拡散方程式を領域分割により並列化した。後はこの応用で相互作用距離が短いモデルはなんでも領域分割できるのだが、二次元、三次元だと、一次元よりちょっと面倒くさい。後、熱伝導方程式は、「最終的になにかに落ち着く」方程式なので、シミュレーションしててあまりおもしろいものではない。そこで、二次元で、差分法で簡単に解けて、かつ結果がそこそこ面白い題材として反応拡散方程式を取り上げる。
<!--- end ---></p>
<h1 id="反応拡散方程式">反応拡散方程式</h1>
<p>反応拡散方程式(reaction-diffusion
system)とは、拡散方程式に力学系がくっついたような系で、様々なパターンを作る。例えば「reaction-diffusion
system」でイメージ検索してみて欲しい。生物の模様なんかがこの方程式系で説明されたりする。</p>
<p>世の中には様々な反応拡散方程式があるのだが、ここでは<a
href="https://groups.csail.mit.edu/mac/projects/amorphous/GrayScott/">Gray-Scottモデル</a>と呼ばれる、以下の方程式系を考えよう。</p>
<p><span class="math display">\[
\frac{\partial u}{\partial t} = D_u \Delta u + u^2 v - (F+k)u
\]</span></p>
<p><span class="math display">\[
\frac{\partial v}{\partial t} = D_v \Delta v - u^2 v + F(1-v)
\]</span></p>
<p>これは<span class="math inline">\(U\)</span>と<span
class="math inline">\(V\)</span>という化学物質の化学反応を模した方程式である。
<span class="math inline">\(U\)</span>が活性化因子、<span
class="math inline">\(V\)</span>が抑制因子と呼ばれる。 <span
class="math inline">\(U\)</span>と<span
class="math inline">\(V\)</span>の濃度を<span
class="math inline">\(u\)</span>、<span
class="math inline">\(v\)</span>とすると、<span
class="math inline">\(V\)</span>の濃いところでは<span
class="math inline">\(U\)</span>が生成されないことがわかる。 <span
class="math inline">\(D_u\)</span>や<span
class="math inline">\(D_v\)</span>は拡散係数であり、<span
class="math inline">\(D_v/D_u = 2\)</span>にとる。つまり、<span
class="math inline">\(V\)</span>の方が拡散しやすい物質となる。
この方程式を計算することにしよう。</p>
<p>ちなみに、世界で広く使われている表記と<span
class="math inline">\(U\)</span>と<span
class="math inline">\(V\)</span>が逆のようである。プログラム全部書き終わってから気がついたので、申し訳ないがそのままにする。</p>
<h1 id="シリアル版">シリアル版</h1>
<p>まず、ある点におけるラプラシアンを返す関数<code>laplacian</code>を用意しよう。中央差分で表現すると、上下左右の点との平均との差で表現すれば良いので、こう書ける。</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> laplacian<span class="op">(</span><span class="dt">int</span> ix<span class="op">,</span> <span class="dt">int</span> iy<span class="op">,</span> vd <span class="op">&amp;</span>s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> ts <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">+=</span> s<span class="op">[</span>ix <span class="op">-</span> <span class="dv">1</span> <span class="op">+</span> iy <span class="op">*</span> L<span class="op">];</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">+=</span> s<span class="op">[</span>ix <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> iy <span class="op">*</span> L<span class="op">];</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">+=</span> s<span class="op">[</span>ix <span class="op">+</span> <span class="op">(</span>iy <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> L<span class="op">];</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">+=</span> s<span class="op">[</span>ix <span class="op">+</span> <span class="op">(</span>iy <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> L<span class="op">];</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">-=</span> <span class="fl">4.0</span> <span class="op">*</span> s<span class="op">[</span>ix <span class="op">+</span> iy <span class="op">*</span> L<span class="op">];</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ts<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>また、<span class="math inline">\(u\)</span>と<span
class="math inline">\(v\)</span>の力学系の部分を計算する関数も作っておこう。</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> calcU<span class="op">(</span><span class="dt">double</span> tu<span class="op">,</span> <span class="dt">double</span> tv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> tu <span class="op">*</span> tu <span class="op">*</span> tv <span class="op">-</span> <span class="op">(</span>F <span class="op">+</span> k<span class="op">)</span> <span class="op">*</span> tu<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> calcV<span class="op">(</span><span class="dt">double</span> tu<span class="op">,</span> <span class="dt">double</span> tv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">-</span>tu <span class="op">*</span> tu <span class="op">*</span> tv <span class="op">+</span> F <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> tv<span class="op">);</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>さて、差分を計算する際、<span
class="math inline">\(t+1\)</span>ステップ目の計算に<span
class="math inline">\(t\)</span>ステップの物理量を使う。 もしここで<span
class="math inline">\(t\)</span>の値をどんどん更新してしまうと、ある場所の物理量を計算する時に<span
class="math inline">\(t\)</span>の値と<span
class="math inline">\(t+1\)</span>の値が混ざっておかしなことになる。実は、一次元拡散方程式ではそれを防ぐため、一度<span
class="math inline">\(t\)</span>の時の値を別の領域にコピーして、それを使って<span
class="math inline">\(t+1\)</span>の値を計算するようにしていた(要するに手抜きである)。しかし、二次元でこれをやるとさすがにコピーのオーバーヘッドが大きい。
そこで、同じ物理量を表す配列を二本ずつ用意して、奇数時刻と偶数時刻で使い分けることにしよう。
具体的には<code>u</code>に対して<code>u2</code>という配列も用意しておく。
いま偶数時刻だとすると<code>u2</code>から<code>u</code>を、奇数時刻なら<code>u</code>から<code>u2</code>を計算する。</p>
<p>というわけで、1ステップ時間発展を行う関数<code>calc</code>はこう書ける。</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> calc<span class="op">(</span>vd <span class="op">&amp;</span>u<span class="op">,</span> vd <span class="op">&amp;</span>v<span class="op">,</span> vd <span class="op">&amp;</span>u2<span class="op">,</span> vd <span class="op">&amp;</span>v2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> iy <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> iy <span class="op">&lt;</span> L <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> iy<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> ix <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> ix <span class="op">&lt;</span> L <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> du <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> dv <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">const</span> <span class="dt">int</span> i <span class="op">=</span> ix <span class="op">+</span> iy <span class="op">*</span> L<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      du <span class="op">=</span> Du <span class="op">*</span> laplacian<span class="op">(</span>ix<span class="op">,</span> iy<span class="op">,</span> u<span class="op">);</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      dv <span class="op">=</span> Dv <span class="op">*</span> laplacian<span class="op">(</span>ix<span class="op">,</span> iy<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      du <span class="op">+=</span> calcU<span class="op">(</span>u<span class="op">[</span>i<span class="op">],</span> v<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      dv <span class="op">+=</span> calcV<span class="op">(</span>u<span class="op">[</span>i<span class="op">],</span> v<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>      u2<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> u<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> du <span class="op">*</span> dt<span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      v2<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> v<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> dv <span class="op">*</span> dt<span class="op">;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Gray-Scott系は、最初に「種」を置いておくと、そこから模様が広がっていく系である。なので最初に種を置いておこう。</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init<span class="op">(</span>vd <span class="op">&amp;</span>u<span class="op">,</span> vd <span class="op">&amp;</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> d <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> i <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> j <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      u<span class="op">[</span>j <span class="op">+</span> i <span class="op">*</span> L<span class="op">]</span> <span class="op">=</span> <span class="fl">0.7</span><span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  d <span class="op">=</span> <span class="dv">6</span><span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> i <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> j <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>      v<span class="op">[</span>j <span class="op">+</span> i <span class="op">*</span> L<span class="op">]</span> <span class="op">=</span> <span class="fl">0.9</span><span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>系の中央のuとvに、それぞれ6x6の領域、12x12の初期値を種として置くコードである。</p>
<p>以上を元に、時間発展を行う<code>main</code>関数はこんな感じになる。</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> V <span class="op">=</span> L <span class="op">*</span> L<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  vd u<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> v<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  vd u2<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> v2<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  init<span class="op">(</span>u<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> TOTAL_STEP<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&amp;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>      calc<span class="op">(</span>u2<span class="op">,</span> v2<span class="op">,</span> u<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      calc<span class="op">(</span>u<span class="op">,</span> v<span class="op">,</span> u2<span class="op">,</span> v2<span class="op">);</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">%</span> INTERVAL <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> save_as_dat<span class="op">(</span>u<span class="op">);</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>先程述べたように、偶数時刻と奇数時刻で二本の配列を使い分けているのに注意。</p>
<p><code>save_as_dat</code>は、呼ばれるたびに配列を連番のファイル名で保存する関数である。</p>
<p>全体のコードはこんな感じになる(<code>gs.cpp</code>)。</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstdio&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fstream&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> L <span class="op">=</span> <span class="dv">128</span><span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> TOTAL_STEP <span class="op">=</span> <span class="dv">20000</span><span class="op">;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> INTERVAL <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">double</span> F <span class="op">=</span> <span class="fl">0.04</span><span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">double</span> k <span class="op">=</span> <span class="fl">0.06075</span><span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">double</span> dt <span class="op">=</span> <span class="fl">0.2</span><span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">double</span> Du <span class="op">=</span> <span class="fl">0.05</span><span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">double</span> Dv <span class="op">=</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vd<span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init<span class="op">(</span>vd <span class="op">&amp;</span>u<span class="op">,</span> vd <span class="op">&amp;</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> d <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> i <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> j <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      u<span class="op">[</span>j <span class="op">+</span> i <span class="op">*</span> L<span class="op">]</span> <span class="op">=</span> <span class="fl">0.7</span><span class="op">;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  d <span class="op">=</span> <span class="dv">6</span><span class="op">;</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> i <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> j <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      v<span class="op">[</span>j <span class="op">+</span> i <span class="op">*</span> L<span class="op">]</span> <span class="op">=</span> <span class="fl">0.9</span><span class="op">;</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> calcU<span class="op">(</span><span class="dt">double</span> tu<span class="op">,</span> <span class="dt">double</span> tv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> tu <span class="op">*</span> tu <span class="op">*</span> tv <span class="op">-</span> <span class="op">(</span>F <span class="op">+</span> k<span class="op">)</span> <span class="op">*</span> tu<span class="op">;</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> calcV<span class="op">(</span><span class="dt">double</span> tu<span class="op">,</span> <span class="dt">double</span> tv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">-</span>tu <span class="op">*</span> tu <span class="op">*</span> tv <span class="op">+</span> F <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> tv<span class="op">);</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> laplacian<span class="op">(</span><span class="dt">int</span> ix<span class="op">,</span> <span class="dt">int</span> iy<span class="op">,</span> vd <span class="op">&amp;</span>s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> ts <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">+=</span> s<span class="op">[</span>ix <span class="op">-</span> <span class="dv">1</span> <span class="op">+</span> iy <span class="op">*</span> L<span class="op">];</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">+=</span> s<span class="op">[</span>ix <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> iy <span class="op">*</span> L<span class="op">];</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">+=</span> s<span class="op">[</span>ix <span class="op">+</span> <span class="op">(</span>iy <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> L<span class="op">];</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">+=</span> s<span class="op">[</span>ix <span class="op">+</span> <span class="op">(</span>iy <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> L<span class="op">];</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>  ts <span class="op">-=</span> <span class="fl">4.0</span> <span class="op">*</span> s<span class="op">[</span>ix <span class="op">+</span> iy <span class="op">*</span> L<span class="op">];</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ts<span class="op">;</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> calc<span class="op">(</span>vd <span class="op">&amp;</span>u<span class="op">,</span> vd <span class="op">&amp;</span>v<span class="op">,</span> vd <span class="op">&amp;</span>u2<span class="op">,</span> vd <span class="op">&amp;</span>v2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> iy <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> iy <span class="op">&lt;</span> L <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> iy<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> ix <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> ix <span class="op">&lt;</span> L <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> du <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> dv <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">const</span> <span class="dt">int</span> i <span class="op">=</span> ix <span class="op">+</span> iy <span class="op">*</span> L<span class="op">;</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>      du <span class="op">=</span> Du <span class="op">*</span> laplacian<span class="op">(</span>ix<span class="op">,</span> iy<span class="op">,</span> u<span class="op">);</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>      dv <span class="op">=</span> Dv <span class="op">*</span> laplacian<span class="op">(</span>ix<span class="op">,</span> iy<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>      du <span class="op">+=</span> calcU<span class="op">(</span>u<span class="op">[</span>i<span class="op">],</span> v<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>      dv <span class="op">+=</span> calcV<span class="op">(</span>u<span class="op">[</span>i<span class="op">],</span> v<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>      u2<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> u<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> du <span class="op">*</span> dt<span class="op">;</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>      v2<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> v<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> dv <span class="op">*</span> dt<span class="op">;</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> save_as_dat<span class="op">(</span>vd <span class="op">&amp;</span>u<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">int</span> index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> filename<span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>  sprintf<span class="op">(</span>filename<span class="op">,</span> <span class="st">&quot;conf</span><span class="sc">%03d</span><span class="st">.dat&quot;</span><span class="op">,</span> index<span class="op">);</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>cout<span class="op"> &lt;&lt;</span> filename <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>ofstream<span class="op"> </span>ofs<span class="op">(</span>filename<span class="op">,</span> <span class="bu">std::</span>ios<span class="bu">::</span>binary<span class="op">);</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>  ofs<span class="op">.</span>write<span class="op">((</span><span class="dt">char</span> <span class="op">*)(</span>u<span class="op">.</span>data<span class="op">()),</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">)*</span>L <span class="op">*</span> L<span class="op">);</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  index<span class="op">++;</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> V <span class="op">=</span> L <span class="op">*</span> L<span class="op">;</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>  vd u<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> v<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>  vd u2<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> v2<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>  init<span class="op">(</span>u<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> TOTAL_STEP<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&amp;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>      calc<span class="op">(</span>u2<span class="op">,</span> v2<span class="op">,</span> u<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>      calc<span class="op">(</span>u<span class="op">,</span> v<span class="op">,</span> u2<span class="op">,</span> v2<span class="op">);</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">%</span> INTERVAL <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> save_as_dat<span class="op">(</span>u<span class="op">);</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>コンパイル、実行してみよう。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> g++ <span class="at">-O3</span> gs.cpp</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> time ./a.out</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conf000.dat</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conf001.dat</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conf002.dat</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">snip</span><span class="kw">)</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ex">conf097.dat</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ex">conf098.dat</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="ex">conf099.dat</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="ex">./a.out</span>  1.61s user 0.03s system 96% cpu 1.697 total</span></code></pre></div>
<p>出てきたデータ(<code>*.dat</code>)は、倍精度実数が<code>L*L</code>個入っている。これをRubyで読み込んでPNG形式で吐く
スクリプトを作っておこう。</p>
<p><a href="image.rb">image.rb</a></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode rb"><code class="sourceCode ruby"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span> <span class="st">&quot;cairo&quot;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span> <span class="st">&quot;pathname&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> convert(datfile)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">puts</span> datfile</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  buf <span class="kw">=</span> <span class="dt">File</span><span class="at">.binread</span>(datfile)<span class="at">.unpack</span>(<span class="st">&quot;d*&quot;</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  l <span class="kw">=</span> <span class="dt">Math</span><span class="at">.sqrt</span>(buf<span class="at">.size</span>)<span class="at">.to_i</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  m <span class="kw">=</span> <span class="dv">4</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  size <span class="kw">=</span> l <span class="kw">*</span> m</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  surface <span class="kw">=</span> <span class="dt">Cairo</span><span class="kw">::</span><span class="dt">ImageSurface</span><span class="at">.new</span>(<span class="dt">Cairo</span><span class="kw">::</span><span class="cn">FORMAT_RGB24</span>, size, size)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  context <span class="kw">=</span> <span class="dt">Cairo</span><span class="kw">::</span><span class="dt">Context</span><span class="at">.new</span>(surface)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  context<span class="at">.set_source_rgb</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  context<span class="at">.rectangle</span>(<span class="dv">0</span>, <span class="dv">0</span>, size, size)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  context<span class="at">.fill</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  l<span class="at">.times</span> <span class="cf">do</span> <span class="kw">|</span>x<span class="kw">|</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    l<span class="at">.times</span> <span class="cf">do</span> <span class="kw">|</span>y<span class="kw">|</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      u <span class="kw">=</span> buf<span class="kw">[</span>x <span class="kw">+</span> y <span class="kw">*</span> l<span class="kw">]</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      context<span class="at">.set_source_rgb</span>(<span class="dv">0</span>, u, <span class="dv">0</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      context<span class="at">.rectangle</span>(x <span class="kw">*</span> m, y <span class="kw">*</span> m, m, m)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>      context<span class="at">.fill</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  pngfile <span class="kw">=</span> <span class="dt">Pathname</span>(datfile)<span class="at">.sub_ext</span>(<span class="st">&quot;.png&quot;</span>)<span class="at">.to_s</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  surface<span class="at">.write_to_png</span>(pngfile)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="in">`ls *.dat`</span><span class="at">.split</span>(<span class="ss">/\n/</span>)<span class="at">.each</span> <span class="cf">do</span> <span class="kw">|</span>f<span class="kw">|</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  convert(f)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>これで一括で処理する。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ruby image.rb</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conf000.dat</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conf001.dat</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conf002.dat</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">snip</span><span class="kw">)</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ex">conf097.dat</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ex">conf098.dat</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">conf099.dat</span></span></code></pre></div>
<p>するとこんな感じの画像が得られる。</p>
<figure>
<img src="fig/gs.png" alt="反応拡散方程式シミュレーションの実行結果" />
<figcaption
aria-hidden="true">反応拡散方程式シミュレーションの実行結果</figcaption>
</figure>
<h1 id="並列化ステップ1-通信の準備など">並列化ステップ1:
通信の準備など</h1>
<p>さて、さっそく反応拡散方程式を二次元領域分割により並列化していくわけだが、
並列化で重要なのは、
<strong>いきなり本番コードで通信アルゴリズムを試さない</strong>
ということである。
まずは、今やろうとしている通信と同じアルゴリズムだけを抜き出したコードを書き、ちゃんと想定通りに通信できていることを確かめる。
実際のデータは倍精度実数だが、とりあえず整数データでいろいろためそう。</p>
<p>まず、通信関連のコードを書く前に、領域分割により、全体をどうやって分割するか、
各プロセスはどこを担当するかといった基本的なセットアップを確認しよう。</p>
<p>いま、LxLのグリッドがあるとしよう。これをprocsプロセスで分割する。
この時、なるべく「のりしろ」が小さくなるように分割したい。
例えば4プロセスなら2x2に、24プロセスなら6x4という具合である。
このためには、与えられたプロセス数を、なるべく似たような数字になるように
因数分解してやらないといけない。
MPIにはそのための関数、<code>MPI_Dims_create</code>が用意されている。
使い方は、二次元分割なら、<code>procs</code>にプロセス数が入っているとして、</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> d2<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="op">{};</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  MPI_Dims_create<span class="op">(</span>procs<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> d2<span class="op">);</span></span></code></pre></div>
<p>のように呼ぶと、<code>d2[0]</code>と<code>d2[1]</code>に分割数が入ってくる。三次元分割をしたければ、</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> d3<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="op">{};</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  MPI_Dims_create<span class="op">(</span>procs<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> d3<span class="op">);</span></span></code></pre></div>
<p>などと、分割数3を指定し、3要素の配列を食わせてやれば良い。
ただし、OpenMPIの<code>MPI_Dims_create</code>は若干動作が怪しいので注意すること。
例えば9プロセスを二次元分割したら3x3になってほしいが、9x1を返してくる。
Intel MPIやSGI
MPTはちゃんと3x3を返してくるので、このあたりは実装依存のようだ。
気になる場合は自分で因数分解コードを書いて欲しい。</p>
<p>さて、procsプロセスを、GX*GYと分割することにしよう。
すると、各プロセスは、横がL/GX、縦がL/GY個のサイトを保持すれば良い。
例えば8x8の系を4プロセスで並列化する際、一つのプロセスが担当するのは4x4となるが、
上下左右に1列余分に必要になるので、合わせて6x6のデータを保持することになる。</p>
<figure>
<img src="fig/margin.png" alt="通信の「のりしろ」" />
<figcaption aria-hidden="true">通信の「のりしろ」</figcaption>
</figure>
<p>また、各プロセスは自分がどの場所を担当しているかも知っておきたいし、担当する領域のサイズも保持しておきたい。
これらに加えてランクや総プロセス数といった並列化情報を、<code>MPIinfo</code>という構造体にまとめて突っ込んで置こう。
とりあえず必要な情報はこんな感じだろうか。</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MPIinfo <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> rank<span class="op">;</span>  <span class="co">//ランク番号</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> procs<span class="op">;</span> <span class="co">//総プロセス数</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> GX<span class="op">,</span> GY<span class="op">;</span> <span class="co">// プロセスをどう分割したか (GX*GY=procs)</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> local_grid_x<span class="op">,</span> local_grid_y<span class="op">;</span> <span class="co">// 自分が担当する位置</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> local_size_x<span class="op">,</span> local_size_y<span class="op">;</span> <span class="co">// 自分が担当する領域のサイズ(のりしろ含まず)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><code>MPIinfo</code>の各値をセットする関数、<code>setup_info</code>を作っておこう。こんな感じかな。</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup_info<span class="op">(</span>MPIinfo <span class="op">&amp;</span>mi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> rank <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> procs <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  MPI_Comm_rank<span class="op">(</span>MPI_COMM_WORLD<span class="op">,</span> <span class="op">&amp;</span>rank<span class="op">);</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  MPI_Comm_size<span class="op">(</span>MPI_COMM_WORLD<span class="op">,</span> <span class="op">&amp;</span>procs<span class="op">);</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> d2<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="op">{};</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  MPI_Dims_create<span class="op">(</span>procs<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> d2<span class="op">);</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  mi<span class="op">.</span>rank <span class="op">=</span> rank<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  mi<span class="op">.</span>procs <span class="op">=</span> procs<span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  mi<span class="op">.</span>GX <span class="op">=</span> d2<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  mi<span class="op">.</span>GY <span class="op">=</span> d2<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  mi<span class="op">.</span>local_grid_x <span class="op">=</span> rank <span class="op">%</span> mi<span class="op">.</span>GX<span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  mi<span class="op">.</span>local_grid_y <span class="op">=</span> rank <span class="op">/</span> mi<span class="op">.</span>GX<span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  mi<span class="op">.</span>local_size_x <span class="op">=</span> L <span class="op">/</span> mi<span class="op">.</span>GX<span class="op">;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  mi<span class="op">.</span>local_size_y <span class="op">=</span> L <span class="op">/</span> mi<span class="op">.</span>GY<span class="op">;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>自分が保持するデータを<code>std::vector&lt;int&gt; local_data</code>として宣言しよう。のりしろの部分も考慮するとこんな感じになる。</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>  MPIinfo mi<span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  setup_info<span class="op">(</span>mi<span class="op">);</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> local_data<span class="op">((</span>mi<span class="op">.</span>local_size_x <span class="op">+</span> <span class="dv">2</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>mi<span class="op">.</span>local_size_y <span class="op">+</span> <span class="dv">2</span><span class="op">),</span> <span class="dv">0</span><span class="op">);</span></span></code></pre></div>
<p>あとの通信がうまくいっているか確認するため、ローカルデータに「のりしろ」以外に通し番号を降っておこう。
例えばL=8で、procs =
4の場合に、各プロセスにこういうデータを保持させたい。</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 0</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 001 002 003 000</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 004 005 006 007 000</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 008 009 010 011 000</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 012 013 014 015 000</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 1</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 016 017 018 019 000</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 020 021 022 023 000</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 024 025 026 027 000</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 028 029 030 031 000</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 2</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 032 033 034 035 000</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 036 037 038 039 000</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 040 041 042 043 000</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 044 045 046 047 000</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 3</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 048 049 050 051 000</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 052 053 054 055 000</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 056 057 058 059 000</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 060 061 062 063 000</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span></code></pre></div>
<p>このような初期化をする関数<code>init</code>を用意する。</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init<span class="op">(</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="op">&amp;</span>local_data<span class="op">,</span> MPIinfo <span class="op">&amp;</span>mi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> offset <span class="op">=</span> mi<span class="op">.</span>local_size_x <span class="op">*</span> mi<span class="op">.</span>local_size_y <span class="op">*</span> mi<span class="op">.</span>rank<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> iy <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> iy <span class="op">&lt;</span> mi<span class="op">.</span>local_size_y<span class="op">;</span> iy<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> ix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ix <span class="op">&lt;</span> mi<span class="op">.</span>local_size_x<span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> index <span class="op">=</span> <span class="op">(</span>ix <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span>iy <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>mi<span class="op">.</span>local_size_x <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> value <span class="op">=</span> ix <span class="op">+</span> iy <span class="op">*</span> mi<span class="op">.</span>local_size_x <span class="op">+</span> offset<span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      local_data<span class="op">[</span>index<span class="op">]</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>自分が担当する領域の左上に来る番号を<code>offset</code>として計算し、そこから通し番号を降っているだけである。
このローカルなデータをダンプする関数も作っておく。</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dump_local_sub<span class="op">(</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="op">&amp;</span>local_data<span class="op">,</span> MPIinfo <span class="op">&amp;</span>mi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;rank = </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> mi<span class="op">.</span>rank<span class="op">);</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> iy <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> iy <span class="op">&lt;</span> mi<span class="op">.</span>local_size_y <span class="op">+</span> <span class="dv">2</span><span class="op">;</span> iy<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> ix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ix <span class="op">&lt;</span> mi<span class="op">.</span>local_size_x <span class="op">+</span> <span class="dv">2</span><span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unsigned</span> <span class="dt">int</span> index <span class="op">=</span> ix <span class="op">+</span> iy <span class="op">*</span> <span class="op">(</span>mi<span class="op">.</span>local_size_x <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>      printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%03d</span><span class="st"> &quot;</span><span class="op">,</span> local_data<span class="op">[</span>index<span class="op">]);</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>dump_local_sub</code>に自分が保持する<code>std::vector</code>を渡せば表示されるのだが、
複数のプロセスから一気に標準出力に吐くと表示が乱れる可能性がある。
各プロセスからファイルに吐いてしまっても良いが、こういう時は、プロセスの数だけループをまわし、ループカウンタが自分のランク番号と同じになった時に書き込む、
というコードが便利である。全プロセスが順番待ちをするので速度は遅いが、主にデバッグに使うので問題ない。
こんな感じである。</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dump_local<span class="op">(</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="op">&amp;</span>local_data<span class="op">,</span> MPIinfo <span class="op">&amp;</span>mi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> mi<span class="op">.</span>procs<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    MPI_Barrier<span class="op">(</span>MPI_COMM_WORLD<span class="op">);</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> mi<span class="op">.</span>rank<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>      dump_local_sub<span class="op">(</span>local_data<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>毎回バリア同期が必要なことに注意。この、</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> procs<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    MPI_Barrier<span class="op">(</span>MPI_COMM_WORLD<span class="op">);</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> rank<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>      do_something<span class="op">();</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>というイディオムは、MPIで頻出するので覚えておくと良いかもしれない。
4プロセス実行し、<code>dump_local</code>を呼ぶと、先程の「のりしろ付きのローカルデータ」がダンプされる。</p>
<h1 id="並列化ステップ2-データの保存">並列化ステップ2: データの保存</h1>
<p>計算を実行するにあたり、必要な通信は、</p>
<ul>
<li>時間発展のための「のりしろ」の通信</li>
<li>計算の途中経過のデータの保存のための集団通信</li>
</ul>
<p>の二種類である。一次元分割の時と同様に、まずは後者、データの保存のための通信を考えよう。</p>
<figure>
<img src="fig/gather.png" alt="データの集約" />
<figcaption aria-hidden="true">データの集約</figcaption>
</figure>
<p>時間発展した結果を保存したいので、各プロセスが保持するデータを集約したい。
各プロセスが保持するデータをローカルデータ、系全体のデータをグローバルデータと呼ぶことにする。
「のりしろ」は計算の時には必要だが、データの保存の時には不要だ。
なので、各プロセスはまず、ローカルデータから「のりしろ」を除いたデータを用意し、
それを<code>MPI_Gather</code>を使ってルートプロセスに集める。</p>
<p>今、各プロセスがこんな感じにデータを持っていたとする。</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 0</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 001 002 003 000</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 004 005 006 007 000</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 008 009 010 011 000</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 012 013 014 015 000</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 1</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 016 017 018 019 000</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 020 021 022 023 000</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 024 025 026 027 000</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 028 029 030 031 000</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 2</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 032 033 034 035 000</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 036 037 038 039 000</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 040 041 042 043 000</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 044 045 046 047 000</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 3</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 048 049 050 051 000</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 052 053 054 055 000</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 056 057 058 059 000</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 060 061 062 063 000</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span></code></pre></div>
<p>000は「のりしろ」である。グローバル領域は二次元的に分割されるが、各プロセスはそれを一次元的に保持しているので、「のりしろ」を除いてデータをコピーするところを除けば、通信部分は一次元の時と同じになる。</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">void</span> gather<span class="er">(</span><span class="ex">std::vector</span><span class="op">&lt;</span>int<span class="op">&gt;</span> <span class="kw">&amp;</span><span class="ex">local_data,</span> MPIinfo <span class="kw">&amp;</span><span class="ex">mi</span><span class="kw">)</span> <span class="kw">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">const</span> int lx = mi.local_size_x<span class="kw">;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">const</span> int ly = mi.local_size_y<span class="kw">;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">std::vector</span><span class="op">&lt;</span>int<span class="op">&gt;</span> sendbuf<span class="er">(</span><span class="ex">lx</span> <span class="pp">*</span> ly<span class="kw">);</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">//</span> 「のりしろ」を除いたデータのコピー</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="kw">(</span><span class="ex">int</span> iy = 0<span class="kw">;</span> <span class="ex">iy</span> <span class="op">&lt;</span> ly<span class="kw">;</span> <span class="ex">iy++</span><span class="kw">)</span> <span class="kw">{</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="kw">(</span><span class="ex">int</span> ix = 0<span class="kw">;</span> <span class="ex">ix</span> <span class="op">&lt;</span> lx<span class="kw">;</span> <span class="ex">ix++</span><span class="kw">)</span> <span class="kw">{</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">int</span> index_from = <span class="er">(</span><span class="ex">ix</span> + 1<span class="kw">)</span> <span class="ex">+</span> <span class="er">(</span><span class="ex">iy</span> + 1<span class="kw">)</span> <span class="ex">*</span> <span class="er">(</span><span class="ex">lx</span> + 2<span class="kw">);</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">int</span> index_to = ix + iy <span class="pp">*</span> lx<span class="kw">;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>      <span class="va">sendbuf</span><span class="op">[</span>index_to<span class="op">]</span> <span class="ex">=</span> local_data[index_from]<span class="kw">;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="ex">std::vector</span><span class="op">&lt;</span>int<span class="op">&gt;</span> recvbuf<span class="kw">;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">(</span><span class="ex">mi.rank</span> == 0<span class="kw">)</span> <span class="kw">{</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">recvbuf.resize</span><span class="er">(</span><span class="ex">lx</span> <span class="pp">*</span> ly <span class="pp">*</span> mi.procs<span class="kw">);</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Gather</span><span class="er">(</span><span class="fu">sendbuf.data()</span><span class="ex">,</span> lx <span class="pp">*</span> ly, MPI_INT, recvbuf.data<span class="er">(</span><span class="kw">)</span><span class="ex">,</span> lx <span class="pp">*</span> ly, MPI_INT, 0,  MPI_COMM_WORLD<span class="kw">);</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="ex">//</span> ここで、ランク0番のプロセスの保持するrecvbufにグローバルデータが入る。</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>しかし、このようにして集約されたグローバルデータは、各プロセスが論理的に保持するデータと場所が異なり、こんな感じになる。</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Before</span> reordering</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 001 002 003 004 005 006 007</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a> <span class="ex">008</span> 009 010 011 012 013 014 015</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">016</span> 017 018 019 020 021 022 023</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">024</span> 025 026 027 028 029 030 031</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">032</span> 033 034 035 036 037 038 039</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">040</span> 041 042 043 044 045 046 047</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">048</span> 049 050 051 052 053 054 055</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">056</span> 057 058 059 060 061 062 063</span></code></pre></div>
<p>数字が連番になっているのがわかるだろうか。デバッグに便利なように、そうなるようにローカルデータに数字を振っておいた。
さて、論理的にはこういう配置になっていて欲しい。</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">After</span> reordering</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 001 002 003 016 017 018 019</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a> <span class="ex">004</span> 005 006 007 020 021 022 023</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">008</span> 009 010 011 024 025 026 027</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">012</span> 013 014 015 028 029 030 031</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">032</span> 033 034 035 048 049 050 051</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">036</span> 037 038 039 052 053 054 055</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">040</span> 041 042 043 056 057 058 059</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">044</span> 045 046 047 060 061 062 063</span></code></pre></div>
<p>というわけで、そうなるようにデータを並び替えればよい。並び替えのための関数<code>reordering</code>はこう書けるだろう。</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> reordering<span class="op">(</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="op">&amp;</span>v<span class="op">,</span> MPIinfo <span class="op">&amp;</span>mi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> v2<span class="op">(</span>v<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>copy<span class="op">(</span>v<span class="op">.</span>begin<span class="op">(),</span> v<span class="op">.</span>end<span class="op">(),</span> v2<span class="op">.</span>begin<span class="op">());</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> lx <span class="op">=</span> mi<span class="op">.</span>local_size_x<span class="op">;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> ly <span class="op">=</span> mi<span class="op">.</span>local_size_y<span class="op">;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> r <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> r <span class="op">&lt;</span> mi<span class="op">.</span>procs<span class="op">;</span> r<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> rx <span class="op">=</span> r <span class="op">%</span> mi<span class="op">.</span>GX<span class="op">;</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ry <span class="op">=</span> r <span class="op">/</span> mi<span class="op">.</span>GX<span class="op">;</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> sx <span class="op">=</span> rx <span class="op">*</span> lx<span class="op">;</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> sy <span class="op">=</span> ry <span class="op">*</span> ly<span class="op">;</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> iy <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> iy <span class="op">&lt;</span> ly<span class="op">;</span> iy<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> ix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ix <span class="op">&lt;</span> lx<span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> index <span class="op">=</span> <span class="op">(</span>sx <span class="op">+</span> ix<span class="op">)</span> <span class="op">+</span> <span class="op">(</span>sy <span class="op">+</span> iy<span class="op">)</span> <span class="op">*</span> L<span class="op">;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        v<span class="op">[</span>index<span class="op">]</span> <span class="op">=</span> v2<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        i<span class="op">++;</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>以上の処理まで含めて、<code>gather</code>完成である。</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> gather<span class="op">(</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="op">&amp;</span>local_data<span class="op">,</span> MPIinfo <span class="op">&amp;</span>mi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> lx <span class="op">=</span> mi<span class="op">.</span>local_size_x<span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> ly <span class="op">=</span> mi<span class="op">.</span>local_size_y<span class="op">;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> sendbuf<span class="op">(</span>lx <span class="op">*</span> ly<span class="op">);</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 「のりしろ」を除いたデータのコピー</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> iy <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> iy <span class="op">&lt;</span> ly<span class="op">;</span> iy<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> ix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ix <span class="op">&lt;</span> lx<span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> index_from <span class="op">=</span> <span class="op">(</span>ix <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span>iy <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>lx <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> index_to <span class="op">=</span> ix <span class="op">+</span> iy <span class="op">*</span> lx<span class="op">;</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      sendbuf<span class="op">[</span>index_to<span class="op">]</span> <span class="op">=</span> local_data<span class="op">[</span>index_from<span class="op">];</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> recvbuf<span class="op">;</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>mi<span class="op">.</span>rank <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    recvbuf<span class="op">.</span>resize<span class="op">(</span>lx <span class="op">*</span> ly <span class="op">*</span> mi<span class="op">.</span>procs<span class="op">);</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  MPI_Gather<span class="op">(</span>sendbuf<span class="op">.</span>data<span class="op">(),</span> lx <span class="op">*</span> ly<span class="op">,</span> MPI_INT<span class="op">,</span> recvbuf<span class="op">.</span>data<span class="op">(),</span> lx <span class="op">*</span> ly<span class="op">,</span> MPI_INT<span class="op">,</span> <span class="dv">0</span><span class="op">,</span>  MPI_COMM_WORLD<span class="op">);</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>mi<span class="op">.</span>rank <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Before reordering</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    dump_global<span class="op">(</span>recvbuf<span class="op">);</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    reordering<span class="op">(</span>recvbuf<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;After reordering</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    dump_global<span class="op">(</span>recvbuf<span class="op">);</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>送信前や送信後にデータの処理が必要となるので、やってることが単純なわりにコード量がそこそこの長さになる。
このあたりが「MPIは面倒くさい」と言われる所以かもしれない。筆者も「MPIは面倒くさい」ことは否定しない。
しかし、ここまで読んでくださった方なら「MPIは難しくはない」ということも同意してもらえると思う。
MPIは書いた通りに動く。なので、通信アルゴリズムが決まっていれば、その手順どおりに書くだけである。
実際面倒なのは通信そのものよりも、通信の前処理と後処理だったりする(そもそも今回も通信は一行だけだ)。</p>
<p>以上をすべてまとめたコードを<code>gather2d.cpp</code>としよう。やや大きいので、ウェブへのリンクを貼っておく。</p>
<p><a
href="https://github.com/kaityo256/sevendayshpc/blob/master/day5/gather2d.cpp">https://github.com/kaityo256/sevendayshpc/blob/master/day5/gather2d.cpp</a></p>
<p>main関数だけ書いておくとこんな感じ。</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  MPI_Init<span class="op">(&amp;</span>argc<span class="op">,</span> <span class="op">&amp;</span>argv<span class="op">);</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  MPIinfo mi<span class="op">;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  setup_info<span class="op">(</span>mi<span class="op">);</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ローカルデータの確保</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> local_data<span class="op">((</span>mi<span class="op">.</span>local_size_x <span class="op">+</span> <span class="dv">2</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>mi<span class="op">.</span>local_size_y <span class="op">+</span> <span class="dv">2</span><span class="op">),</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ローカルデータの初期化</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  init<span class="op">(</span>local_data<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ローカルデータの表示</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  dump_local<span class="op">(</span>local_data<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ローカルデータを集約してグローバルデータに</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  gather<span class="op">(</span>local_data<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  MPI_Finalize<span class="op">();</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>まぁ、そのまんま手続きを書いただけですね。</p>
<h1 id="並列化ステップ2-のりしろの通信">並列化ステップ2:
のりしろの通信</h1>
<p>さて、計算を実行するためには、上下左右のプロセスから自分の「のりしろ」に情報を受け取らないといけない。
問題は、二次元の場合には角の情報、つまり「斜め方向」の通信も必要なことである。
普通に考えると、左右2回、上下2回、角4つで8回の通信が必要となるのだが、左右から受け取ったデータを、上下に転送することで、4回の通信で斜め方向の通信も完了する。</p>
<p>どうでも良いが筆者は昔ブログを書いており(今は書いてないが)、「斜め方向の通信どうするかなぁ」と書いたら、日記の読者二人から別々にこのアルゴリズムを教えていただいた(その節はありがとうございます)。ブログも書いてみるものである。</p>
<p>データの転送を図解するとこんな感じになる。まず、左右方向の通信。実際の例では2x2分割のため、自分から見て左にいるプロセスと右にいるプロセスが同一になってしまうが、図では別プロセスとして描いているから注意。</p>
<figure>
<img src="fig/sendrecv_x.png" alt="x軸方向の通信" />
<figcaption aria-hidden="true">x軸方向の通信</figcaption>
</figure>
<p>左右の通信が終わったら、左右からもらったデータも込みで上下に転送する。以下は、「下から受け取り、上に送る」通信。</p>
<figure>
<img src="fig/sendrecv_y.png" alt="y軸方向の通信" />
<figcaption aria-hidden="true">y軸方向の通信</figcaption>
</figure>
<p>最後の点線で囲ったデータが「斜め方向のプロセスが保持していたデータ」であり、間接的に受け取ったことになる。</p>
<p>まず、上下左右にいるプロセス番号を知りたい。<code>MPIinfo</code>に<code>get_rank</code>メソッドを追加しておこう。</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MPIinfo <span class="op">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> rank<span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> procs<span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> GX<span class="op">,</span> GY<span class="op">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> local_grid_x<span class="op">,</span> local_grid_y<span class="op">;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> local_size_x<span class="op">,</span> local_size_y<span class="op">;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 自分から見て(dx,dy)だけずれたプロセスのrankを返す</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> get_rank<span class="op">(</span><span class="dt">int</span> dx<span class="op">,</span> <span class="dt">int</span> dy<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> rx <span class="op">=</span> <span class="op">(</span>local_grid_x <span class="op">+</span> dx <span class="op">+</span> GX<span class="op">)</span> <span class="op">%</span> GX<span class="op">;</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ry <span class="op">=</span> <span class="op">(</span>local_grid_y <span class="op">+</span> dy <span class="op">+</span> GY<span class="op">)</span> <span class="op">%</span> GY<span class="op">;</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rx <span class="op">+</span> ry <span class="op">*</span> GX<span class="op">;</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>これを使って、左右(x方向)に通信して、右と左の「のりしろ」データを交換するコードはこんな感じに書ける。</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sendrecv_x<span class="op">(</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="op">&amp;</span>local_data<span class="op">,</span> MPIinfo <span class="op">&amp;</span>mi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> lx <span class="op">=</span> mi<span class="op">.</span>local_size_x<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> ly <span class="op">=</span> mi<span class="op">.</span>local_size_y<span class="op">;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> sendbuf<span class="op">(</span>ly<span class="op">);</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> recvbuf<span class="op">(</span>ly<span class="op">);</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> left <span class="op">=</span> mi<span class="op">.</span>get_rank<span class="op">(-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> right <span class="op">=</span> mi<span class="op">.</span>get_rank<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ly<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> index <span class="op">=</span> lx <span class="op">+</span> <span class="op">(</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>lx <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    sendbuf<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> local_data<span class="op">[</span>index<span class="op">];</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  MPI_Status st<span class="op">;</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  MPI_Sendrecv<span class="op">(</span>sendbuf<span class="op">.</span>data<span class="op">(),</span> ly<span class="op">,</span> MPI_INT<span class="op">,</span> right<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>               recvbuf<span class="op">.</span>data<span class="op">(),</span> ly<span class="op">,</span> MPI_INT<span class="op">,</span> left<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> MPI_COMM_WORLD<span class="op">,</span> <span class="op">&amp;</span>st<span class="op">);</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ly<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> index <span class="op">=</span> <span class="op">(</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>lx <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    local_data<span class="op">[</span>index<span class="op">]</span> <span class="op">=</span> recvbuf<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ly<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> index <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> <span class="op">(</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>lx <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    sendbuf<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> local_data<span class="op">[</span>index<span class="op">];</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  MPI_Sendrecv<span class="op">(</span>sendbuf<span class="op">.</span>data<span class="op">(),</span> ly<span class="op">,</span> MPI_INT<span class="op">,</span> left<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>               recvbuf<span class="op">.</span>data<span class="op">(),</span> ly<span class="op">,</span> MPI_INT<span class="op">,</span> right<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> MPI_COMM_WORLD<span class="op">,</span> <span class="op">&amp;</span>st<span class="op">);</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ly<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> index <span class="op">=</span> lx <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> <span class="op">(</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>lx <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    local_data<span class="op">[</span>index<span class="op">]</span> <span class="op">=</span> recvbuf<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>全く同様にy方向の通信も書けるが、先に述べたように「左右からもらったデータも転送」するため、その分がちょっとだけ異なる。</p>
<p>このアルゴリズムを実装するとこんな感じになる。</p>
<p><a
href="https://github.com/kaityo256/sevendayshpc/blob/master/day5/sendrecv.cpp">https://github.com/kaityo256/sevendayshpc/blob/master/day5/sendrecv.cpp</a></p>
<p>実行結果はこんな感じ。</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mpic++ sendrecv.cpp</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mpirun <span class="at">-np</span> 4 ./a.out</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 通信前</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 0</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 001 002 003 000</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 004 005 006 007 000</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 008 009 010 011 000</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 012 013 014 015 000</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 1</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 016 017 018 019 000</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 020 021 022 023 000</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 024 025 026 027 000</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 028 029 030 031 000</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 2</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 032 033 034 035 000</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 036 037 038 039 000</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 040 041 042 043 000</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 044 045 046 047 000</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 3</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 048 049 050 051 000</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 052 053 054 055 000</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 056 057 058 059 000</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 060 061 062 063 000</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 左右の通信終了後</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 0</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a> <span class="ex">019</span> 000 001 002 003 016</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a> <span class="ex">023</span> 004 005 006 007 020</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a> <span class="ex">027</span> 008 009 010 011 024</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a> <span class="ex">031</span> 012 013 014 015 028</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 1</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a> <span class="ex">003</span> 016 017 018 019 000</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a> <span class="ex">007</span> 020 021 022 023 004</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a> <span class="ex">011</span> 024 025 026 027 008</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a> <span class="ex">015</span> 028 029 030 031 012</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 2</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a> <span class="ex">051</span> 032 033 034 035 048</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a> <span class="ex">055</span> 036 037 038 039 052</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a> <span class="ex">059</span> 040 041 042 043 056</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a> <span class="ex">063</span> 044 045 046 047 060</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 3</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a> <span class="ex">035</span> 048 049 050 051 032</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a> <span class="ex">039</span> 052 053 054 055 036</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a> <span class="ex">043</span> 056 057 058 059 040</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a> <span class="ex">047</span> 060 061 062 063 044</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a> <span class="ex">000</span> 000 000 000 000 000</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a><span class="co"># 上下の通信終了後 (これで斜め方向も完了)</span></span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 0</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a> <span class="ex">063</span> 044 045 046 047 060</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a> <span class="ex">019</span> 000 001 002 003 016</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a> <span class="ex">023</span> 004 005 006 007 020</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a> <span class="ex">027</span> 008 009 010 011 024</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a> <span class="ex">031</span> 012 013 014 015 028</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a> <span class="ex">051</span> 032 033 034 035 048</span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 1</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a> <span class="ex">047</span> 060 061 062 063 044</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a> <span class="ex">003</span> 016 017 018 019 000</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a> <span class="ex">007</span> 020 021 022 023 004</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a> <span class="ex">011</span> 024 025 026 027 008</span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a> <span class="ex">015</span> 028 029 030 031 012</span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a> <span class="ex">035</span> 048 049 050 051 032</span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 2</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a> <span class="ex">031</span> 012 013 014 015 028</span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a> <span class="ex">051</span> 032 033 034 035 048</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a> <span class="ex">055</span> 036 037 038 039 052</span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a> <span class="ex">059</span> 040 041 042 043 056</span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a> <span class="ex">063</span> 044 045 046 047 060</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a> <span class="ex">019</span> 000 001 002 003 016</span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a><span class="ex">rank</span> = 3</span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a> <span class="ex">015</span> 028 029 030 031 012</span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a> <span class="ex">035</span> 048 049 050 051 032</span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a> <span class="ex">039</span> 052 053 054 055 036</span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a> <span class="ex">043</span> 056 057 058 059 040</span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a> <span class="ex">047</span> 060 061 062 063 044</span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a> <span class="ex">003</span> 016 017 018 019 000</span></code></pre></div>
<p>先の図と比べて、正しく通信が行われていることを確認してほしい。</p>
<p>結局、通信プログラムとはこういうことをする。</p>
<ul>
<li>送信バッファと受信バッファを用意する</li>
<li>送信バッファに送るべきデータをコピー</li>
<li>通信する</li>
<li>受信バッファに来たデータを必要な場所にコピー</li>
</ul>
<p>通信そのものは関数呼び出し一発で難しくも面倒でもないが、送受信バッファの作業が面倒くさい。</p>
<h1 id="並列化ステップ3-並列コードの実装">並列化ステップ3:
並列コードの実装</h1>
<p>通信に使うアルゴリズムの確認が終わったので、いよいよ差分法コードに実装してみよう。まず、初期化の部分を考えないといけない。初期化についてはグローバル座標で考えたいが、実際に値を入れるのは各プロセスが保持するローカルデータである。そこで、「このグローバル座標が自分の領域に含まれるか？」「含まれるなら、そのインデックスはどこか？」が知りたくなる。それをMPIinfoのメソッドとして追加しておこう。</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MPIinfo <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> rank<span class="op">;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> procs<span class="op">;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> GX<span class="op">,</span> GY<span class="op">;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> local_grid_x<span class="op">,</span> local_grid_y<span class="op">;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> local_size_x<span class="op">,</span> local_size_y<span class="op">;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 自分から見て +dx, +dyだけずれたプロセスのランクを返す</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> get_rank<span class="op">(</span><span class="dt">int</span> dx<span class="op">,</span> <span class="dt">int</span> dy<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> rx <span class="op">=</span> <span class="op">(</span>local_grid_x <span class="op">+</span> dx <span class="op">+</span> GX<span class="op">)</span> <span class="op">%</span> GX<span class="op">;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ry <span class="op">=</span> <span class="op">(</span>local_grid_y <span class="op">+</span> dy <span class="op">+</span> GY<span class="op">)</span> <span class="op">%</span> GY<span class="op">;</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rx <span class="op">+</span> ry <span class="op">*</span> GX<span class="op">;</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 自分の領域に含まれるか</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> is_inside<span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> sx <span class="op">=</span> local_size_x <span class="op">*</span> local_grid_x<span class="op">;</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> sy <span class="op">=</span> local_size_y <span class="op">*</span> local_grid_y<span class="op">;</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ex <span class="op">=</span> sx <span class="op">+</span> local_size_x<span class="op">;</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ey <span class="op">=</span> sy <span class="op">+</span> local_size_y<span class="op">;</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>x <span class="op">&lt;</span> sx<span class="op">)</span><span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>x <span class="op">&gt;=</span> ex<span class="op">)</span><span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>y <span class="op">&lt;</span> sy<span class="op">)</span><span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>y <span class="op">&gt;=</span> ey<span class="op">)</span><span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">// グローバル座標をローカルインデックスに</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> g2i<span class="op">(</span><span class="dt">int</span> gx<span class="op">,</span> <span class="dt">int</span> gy<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> sx <span class="op">=</span> local_size_x <span class="op">*</span> local_grid_x<span class="op">;</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> sy <span class="op">=</span> local_size_y <span class="op">*</span> local_grid_y<span class="op">;</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> x <span class="op">=</span> gx <span class="op">-</span> sx<span class="op">;</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> y <span class="op">=</span> gy <span class="op">-</span> sy<span class="op">;</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>x <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span>y <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>local_size_x <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>そうすると、初期化処理はこんな感じにかける。</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init<span class="op">(</span>vd <span class="op">&amp;</span>u<span class="op">,</span> vd <span class="op">&amp;</span>v<span class="op">,</span> MPIinfo <span class="op">&amp;</span>mi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> d <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> i <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> j <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>mi<span class="op">.</span>is_inside<span class="op">(</span>i<span class="op">,</span> j<span class="op">))</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> k <span class="op">=</span> mi<span class="op">.</span>g2i<span class="op">(</span>i<span class="op">,</span> j<span class="op">);</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>      u<span class="op">[</span>k<span class="op">]</span> <span class="op">=</span> <span class="fl">0.7</span><span class="op">;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  d <span class="op">=</span> <span class="dv">6</span><span class="op">;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> i <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> d<span class="op">;</span> j <span class="op">&lt;</span> L <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> d<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>mi<span class="op">.</span>is_inside<span class="op">(</span>i<span class="op">,</span> j<span class="op">))</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> k <span class="op">=</span> mi<span class="op">.</span>g2i<span class="op">(</span>i<span class="op">,</span> j<span class="op">);</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>      v<span class="op">[</span>k<span class="op">]</span> <span class="op">=</span> <span class="fl">0.9</span><span class="op">;</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>要するにグローバル座標でループを回してしまって、自分の領域に入っていたら(<code>mi.is_inside(i, j)==true</code>)、ローカルインデックスを取得して、そこに値を書き込む、というだけのコードである。自分の守備範囲外もループが回って非効率に思えるかもしれないが、どうせ初期化処理は最初に一度しか走らないし、こうしておくと他の初期化をしたい時や、ファイルから読み込む時に、シリアルコードと並列コードで同じファイルが使えたりして便利である。</p>
<p>初期化処理が済んだら、可視化用のファイル保存コードを書こう。といっても、ステップ2で書いたコードを<code>int</code>から<code>double</code>に変えて、標準出力にダンプしていたのをファイルに保存するだけである。</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 各プロセスから保存用のデータを受け取ってセーブ</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> save_as_dat_mpi<span class="op">(</span>vd <span class="op">&amp;</span>local_data<span class="op">,</span> MPIinfo <span class="op">&amp;</span>mi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> lx <span class="op">=</span> mi<span class="op">.</span>local_size_x<span class="op">;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> ly <span class="op">=</span> mi<span class="op">.</span>local_size_y<span class="op">;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  vd sendbuf<span class="op">(</span>lx <span class="op">*</span> ly<span class="op">);</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 「のりしろ」を除いたデータのコピー</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> iy <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> iy <span class="op">&lt;</span> ly<span class="op">;</span> iy<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> ix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ix <span class="op">&lt;</span> lx<span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> index_from <span class="op">=</span> <span class="op">(</span>ix <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span>iy <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>lx <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> index_to <span class="op">=</span> ix <span class="op">+</span> iy <span class="op">*</span> lx<span class="op">;</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>      sendbuf<span class="op">[</span>index_to<span class="op">]</span> <span class="op">=</span> local_data<span class="op">[</span>index_from<span class="op">];</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  vd recvbuf<span class="op">;</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>mi<span class="op">.</span>rank <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    recvbuf<span class="op">.</span>resize<span class="op">(</span>lx <span class="op">*</span> ly <span class="op">*</span> mi<span class="op">.</span>procs<span class="op">);</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  MPI_Gather<span class="op">(</span>sendbuf<span class="op">.</span>data<span class="op">(),</span> lx <span class="op">*</span> ly<span class="op">,</span> MPI_DOUBLE<span class="op">,</span> recvbuf<span class="op">.</span>data<span class="op">(),</span> lx <span class="op">*</span> ly<span class="op">,</span> MPI_DOUBLE<span class="op">,</span> <span class="dv">0</span><span class="op">,</span>  MPI_COMM_WORLD<span class="op">);</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>mi<span class="op">.</span>rank <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    reordering<span class="op">(</span>recvbuf<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    save_as_dat<span class="op">(</span>recvbuf<span class="op">);</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>データの再配置(<code>reordering</code>)もほとんど同じなので割愛。ここで、
<strong>いきなり時間発展させずに</strong>
初期化処理をしてからファイルに保存し、正しく初期化、保存できているか確認しておこう。</p>
<p>「のりしろ」の通信部分も、基本的に<code>int</code>を<code>double</code>に変更するだけなので割愛。ただし、<code>u</code>と<code>v</code>の両方を通信しないといけないので、それをまとめて行う関数を作っておこう。</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sendrecv<span class="op">(</span>vd <span class="op">&amp;</span>u<span class="op">,</span> vd <span class="op">&amp;</span>v<span class="op">,</span> MPIinfo <span class="op">&amp;</span>mi<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  sendrecv_x<span class="op">(</span>u<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  sendrecv_y<span class="op">(</span>u<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  sendrecv_x<span class="op">(</span>v<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  sendrecv_y<span class="op">(</span>v<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>これを時間発展直前に呼び出せば、「のりしろ」部分の通信が完了している。
ここでも、<strong>いきなり時間発展させずに</strong>
初期化処理を行った後に「のりしろ通信」を行い、ローカルデータをダンプして正しく通信できているか確認しよう。</p>
<p>そこまでできればあとはシリアル版とほぼ同じ。main関数はこんな感じになる。</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  MPI_Init<span class="op">(&amp;</span>argc<span class="op">,</span> <span class="op">&amp;</span>argv<span class="op">);</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  MPIinfo mi<span class="op">;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  setup_info<span class="op">(</span>mi<span class="op">);</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> V <span class="op">=</span> <span class="op">(</span>mi<span class="op">.</span>local_size_x <span class="op">+</span> <span class="dv">2</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>mi<span class="op">.</span>local_size_y <span class="op">+</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  vd u<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> v<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  vd u2<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">),</span> v2<span class="op">(</span>V<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  init<span class="op">(</span>u<span class="op">,</span> v<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> TOTAL_STEP<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&amp;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>      sendrecv<span class="op">(</span>u2<span class="op">,</span> v2<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>      calc<span class="op">(</span>u2<span class="op">,</span> v2<span class="op">,</span> u<span class="op">,</span> v<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>      sendrecv<span class="op">(</span>u<span class="op">,</span> v<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>      calc<span class="op">(</span>u<span class="op">,</span> v<span class="op">,</span> u2<span class="op">,</span> v2<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">%</span> INTERVAL <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> save_as_dat_mpi<span class="op">(</span>u<span class="op">,</span> mi<span class="op">);</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  MPI_Finalize<span class="op">();</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>MPIの初期化、終了処理、および計算の直前に通信を呼んでるところ以外はシリアル版と変わらないことがわかる。</p>
<p>実行してみよう。普通の<code>mpic++</code>を使ってしまうと<code>clang++</code>が呼ばれてしまう。先程、<code>g++</code>でコンパイルしたシリアル版と実行時間を比較するため、明示的に<code>g++</code>でコンパイルして実行しよう。筆者の環境ではMPIのヘッダやライブラリにパスが通っているので、<code>-lmpi -lmpi_cxx</code>をつけるだけでコンパイルできる。</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> g++ <span class="at">-O3</span> gs_mpi.cpp <span class="at">-lmpi</span> <span class="at">-lmpi_cxx</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> time mpirun <span class="at">-np</span> 4 <span class="at">--oversubscribe</span> ./a.out</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conf000.dat</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conf001.dat</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conf002.dat</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">snip</span><span class="kw">)</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="ex">conf098.dat</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="ex">conf099.dat</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="ex">mpirun</span> <span class="at">-np</span> 4 <span class="at">--oversubscribe</span> ./a.out  2.39s user 0.29s system 321% cpu 0.832 total</span></code></pre></div>
<p><code>time</code>コマンドで出てくる<code>%</code>は、どれだけCPUコアを使ったかを表している。一つのCPUコアを使い切ると100%になる。ここでは321%と表示されているため、4コアを使った並列計算ができていることがわかる。実行時間も1.697s→0.832sと倍近く早くなっている。
シリアル版を<code>serial</code>、MPI版を<code>mpi</code>というディレクトリで実行し、それぞれにデータファイルがあるとして、<code>diff</code>で確認してみよう。時間発展前する前は当然同じ結果になる。</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> diff <span class="at">-s</span> serial/conf000.dat mpi/conf000.dat</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Files</span> serial/conf000.dat and mpi/conf000.dat are identical</span></code></pre></div>
<p>しかし、誤差の関係で、次のステップから結果がずれていく。</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> diff <span class="at">-s</span> serial/conf001.dat mpi/conf001.dat</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Binary</span> files serial/conf001.dat and mpi/conf001.dat differ</span></code></pre></div>
<p>これは、シリアル版とMPI版で加算の順序が変わることによる。しかし、本質的には同じ計算をしているので、可視化すると同じような図が出てくるはずである。見てみよう。</p>
<figure>
<img src="fig/serial_and_mpi.png"
alt="シリアル版とMPI版の時間発展の比較" />
<figcaption
aria-hidden="true">シリアル版とMPI版の時間発展の比較</figcaption>
</figure>
<p>うん、大丈夫そうですね。</p>
<p>さて、実行時間は1.697s→0.832sと2倍近くなったが、使ったCPUコアは4コアであった。つまり、理想的には4倍早くなって欲しいのに、2倍近くしか早くなっていない。並列化効率は50%程度である。</p>
<p>ん？並列化効率が物足りない？
<strong>そういう時はウィースケーリングに逃げてサイズで殴る</strong>。</p>
<p>というわけでサイズをでかくする。一辺4倍にして再度実行してみよう。</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode diff"><code class="sourceCode diff"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="st">-const int L = 128;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="va">+const int L = 512;</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> g++ <span class="at">-O3</span> gs.cpp</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> time ./a.out</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">snip</span><span class="kw">)</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="ex">./a.out</span>  57.98s user 0.16s system 99% cpu 58.248 total</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> g++ <span class="at">-O3</span> gs_mpi.cpp <span class="at">-lmpi</span> <span class="at">-lmpi_cxx</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> time mpirun <span class="at">-np</span> 4 <span class="at">--oversubscribe</span> ./a.out</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="ex">./a.out</span>  57.98s user 0.16s system 99% cpu 58.248 total</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="ex">mpirun</span> <span class="at">-np</span> 4 <span class="at">--oversubscribe</span> ./a.out  68.28s user 1.72s system 382% cpu 18.305 total</span></code></pre></div>
<p>実行時間が58.248s →
18.305となり、並列化効率も80%近くに向上した。それでもなんか文句を言ってくる人がいたら、とてもローカルPCのメモリには乗りきらないほど大きな系を計算して黙らせよう。「並列化効率で悩んだらサイズに逃げろ」と覚えておくと良い。</p>
<h1 id="余談mpiの面倒くささ">余談：MPIの面倒くささ</h1>
<p>本格的な領域分割コードの例として、二次元反応拡散方程式を並列化してみた。「並列化」によってどれくらいコードが増えたか見てみよう。</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> wc gs.cpp gs_mpi.cpp</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>      <span class="ex">89</span>     430    1969 gs.cpp</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>     <span class="ex">272</span>    1271    7345 gs_mpi.cpp</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>     <span class="ex">361</span>    1701    9314 total</span></code></pre></div>
<p>というわけで、89行から272行になった。3倍増である。つまり、もともとの計算コードの二倍の量の通信コードがついたことになる。といっても、「通信コードそのもの」の量は大したことがない。</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> grep MPI_ gs_mpi.cpp</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Comm_rank</span><span class="er">(</span><span class="ex">MPI_COMM_WORLD,</span> <span class="kw">&amp;</span><span class="ex">rank</span><span class="kw">);</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Comm_size</span><span class="er">(</span><span class="ex">MPI_COMM_WORLD,</span> <span class="kw">&amp;</span><span class="ex">procs</span><span class="kw">);</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Dims_create</span><span class="er">(</span><span class="ex">procs,</span> 2, d2<span class="kw">);</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Gather</span><span class="er">(</span><span class="fu">sendbuf.data()</span><span class="ex">,</span> lx <span class="pp">*</span> ly, MPI_DOUBLE, recvbuf.data<span class="er">(</span><span class="kw">)</span><span class="ex">,</span> lx <span class="pp">*</span> ly, MPI_DOUBLE, 0,  MPI_COMM_WORLD<span class="kw">);</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Status</span> st<span class="kw">;</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Sendrecv</span><span class="er">(</span><span class="fu">sendbuf.data()</span><span class="ex">,</span> ly, MPI_DOUBLE, right, 0,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>               <span class="fu">recvbuf.data()</span><span class="ex">,</span> ly, MPI_DOUBLE, left, 0, MPI_COMM_WORLD, <span class="kw">&amp;</span><span class="ex">st</span><span class="kw">);</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Sendrecv</span><span class="er">(</span><span class="fu">sendbuf.data()</span><span class="ex">,</span> ly, MPI_DOUBLE, left, 0,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>               <span class="fu">recvbuf.data()</span><span class="ex">,</span> ly, MPI_DOUBLE, right, 0, MPI_COMM_WORLD, <span class="kw">&amp;</span><span class="ex">st</span><span class="kw">);</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Status</span> st<span class="kw">;</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Sendrecv</span><span class="er">(</span><span class="fu">sendbuf.data()</span><span class="ex">,</span> lx + 2, MPI_DOUBLE, up, 0,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>               <span class="fu">recvbuf.data()</span><span class="ex">,</span> lx + 2, MPI_DOUBLE, down, 0, MPI_COMM_WORLD, <span class="kw">&amp;</span><span class="ex">st</span><span class="kw">);</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Sendrecv</span><span class="er">(</span><span class="fu">sendbuf.data()</span><span class="ex">,</span> lx + 2, MPI_DOUBLE, down, 0,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>               <span class="fu">recvbuf.data()</span><span class="ex">,</span> lx + 2, MPI_DOUBLE, up, 0, MPI_COMM_WORLD, <span class="kw">&amp;</span><span class="ex">st</span><span class="kw">);</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="ex">MPI_Init</span><span class="er">(</span><span class="kw">&amp;</span><span class="ex">argc,</span> <span class="kw">&amp;</span><span class="ex">argv</span><span class="kw">);</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MPI_Finalize()</span><span class="kw">;</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> grep MPI_ gs_mpi.cpp <span class="kw">|</span> <span class="fu">wc</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>      <span class="ex">16</span>      82     850</span></code></pre></div>
<p><code>MPI_Status st</code>の宣言を除くと14行だけである。それ以外はバッファの準備と整理に費やされている。
これをもって「MPIは面倒くさい」というのであれば、私は同意する。しかし、「MPIの面倒くささ」の本質はそこではないように思う。</p>
<p>MPIを使って並列コードを書くことを「並列化
(parallelization)」と呼ぶ。「並列化」という言葉から想像されるのは、「もともとあるシリアル版のコードを改造して並列コードを書く」という作業であろう。典型的には、</p>
<ol type="1">
<li>シリアルコードを書く</li>
<li>大きな系がやりたくなったので、OpenMPを使ってスレッド並列をする</li>
<li>さらにMPIを使って並列版に修正する</li>
</ol>
<p>といった開発プロセスとなりがちなのだと思われる。しかし、既存のコードを修正してMPIを入れていく作業は極めて面倒くさく、バグが入りやすく、かつやっている最中に何をやってるかわからなくなりがちである。一度何をやってるかわからない状態になったら、もうどこがバグなのか、バグが何に起因するのかわからず、泥沼にハマっていく。筆者は、学生さんだけでなくプログラムで飯を食っているプロな人でもそういう状態になっているのを何度も目撃している。</p>
<p>さて、スレッド並列はともかく、<strong>MPIを使った並列化とは、MPI向けに新規にコードを書き直す作業</strong>である。「正しい」並列化プロセスは以下の通りとなる。</p>
<ol type="1">
<li>シリアルコードを書く</li>
<li>MPI並列化に必要な通信パターンを抽出する</li>
<li>その通信パターンだけを抜き出してテストコードを書く</li>
<li>シリアルコードとテストコードを参照しながら、新規にコードを開発する</li>
</ol>
<p>具体的に4つ目のプロセスでは、「初期化してgatherして保存し、正しいことを確認」「初期化後にのりしろ通信して、正しいことを確認」してから、次のステップに進んでいる。並列版として開発した<code>gs_mpi.cpp</code>は、シリアル版である<code>gs.cpp</code>をコピーせず、<code>gs.cpp</code>を参照しながらゼロから開発していった。MPIは面倒である。その感覚は正しい。しかし、順を追って開発していけば、別に難しくはない。ソースコードが三倍になった、というと「うっ」と思うかもしれないが、それでも300行も無いのだし、通信コードを書くこと自体は対して時間はかからない。並列化に限ったことではないが、プログラムの開発時間のほとんどはデバッグでしめられている。面倒臭がらずに、通信ロジックのテストコードなどをきちんと書いていけば、さほど時間はかからずに並列化することができるだろう。</p>
<p>もし2万行のソースコードを渡されて「並列化しろ」と言われたら？それはもうご愁傷様としか……</p>
</article>
</body>
</html>
